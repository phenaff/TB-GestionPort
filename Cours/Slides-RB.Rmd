---
title: "Risk Budgeting"
author: "P. HÃ©naff"
date: "3/2021"
output:
  beamer_presentation:
    colortheme: dolphin
    theme: Montpellier
  slidy_presentation: default

header-includes:
  - \usepackage[utf8]{inputenc}
  - \usepackage{graphicx}
  - \usepackage{subfig}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}

  
bibliography: ../../library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
```

```{r load-libraries, include=FALSE, echo=FALSE}
library(quantmod)
library(xts)
library(hornpa)
library(lubridate)
library(xtable)
library(PerformanceAnalytics)
library(TTR)
library(SuppDists)
library(lubridate)
library(roll)
library(Hmisc)
library(nFactors)
library(quadprog)
library(knitr)
library(kableExtra)
library(latex2exp)
library(FFdownload)
library(fPortfolio)
library(BLCOP)
library(mnormt)
library(riskParityPortfolio)



get.src.folder <- function() {
  path.expand("../GP/src")
}

get.data.folder <- function() {
  path.expand("../GP/data")
}

source(file.path(get.src.folder(), 'utils.R'))
source(file.path(get.src.folder(), 'FileUtils.R'))
```


## Risk Budgeting

$$
\sigma(w) = w^T \Sigma w
$$

Contribution au risque de l'actif $i$:

$$
\mbox{RC}_i = \frac{w_i \left(\Sigma w \right)_i}{\sqrt{w^T \Sigma w}}
$$

## Risk Parity & Budgeting

Parity:

$$
\mbox{RC}_i = \frac{1}{N} \sigma(w)
$$

Bugeting:

$$
\mbox{RC}_i = b_i \sigma(w)
$$

## Cas Paticulier: $\Sigma$ diagonal

$$
\Omega = \sqrt{\mbox{diag}(\Sigma)}
$$
$$
w = \frac{\Omega^{-1}}{1^T \Omega^{-1}}
$$


## Risk Parity & Budgeting: Exemple.

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
monthly.ret.file <- "./monthly.ret.rda"
tickers <- c("AAPL", "AMZN", "MSFT", "F", "SPY", "QQQ", "XOM", "MMM", "HD", "PG", "KO")
if(!file.exists(monthly.ret.file)) {
monthly.ret <- NULL
for(t in tickers) {
  p <- getSymbols(t, auto.assign = FALSE)
  tmp <- monthlyReturn(p[, 6])
  colnames(tmp) <- t
  if(is.null(monthly.ret)) {
    monthly.ret <- tmp
  } else {
    monthly.ret <- cbind(monthly.ret, tmp)
  }
}
monthly.ret <- removeNA(monthly.ret)
save(monthly.ret, file='monthly.ret.rda')
}
load(monthly.ret.file)
```


```{r, echo=TRUE}
Sigma <- cov(monthly.ret)
mu <- colMeans(monthly.ret)
rpp_naive <- riskParityPortfolio(Sigma, formulation = "diag")
rpp_vanilla <- riskParityPortfolio(Sigma)
rpp_mu <- riskParityPortfolio(Sigma, formulation = "rc-over-b-double-index",
                              mu = mu, lmd_mu = 1e-3,
                              w_ub = 0.16)     

w_all <- cbind("EWP"           = rep(1/nrow(Sigma), nrow(Sigma)),
               "RPP (naive)"   = rpp_naive$w)

```

## Risk Budgeting

```{r}
barplotPortfolioRisk(w_all, Sigma)
```

## Risk Budgeting

```{r}
w_all = cbind("RPP (vanilla)" = rpp_vanilla$w,
               "RPP + mu"      = rpp_mu$w)

barplotPortfolioRisk(w_all, Sigma)
```

## Exercice

Utiliser le package "riskParityPortfolio" et le dataset "monthly returns".

A partir de l'exemple: "A pratical example using FAANG price data", comparer par un backtest les performances et la composition d'un portefeuille tangent et d'un portefeuille "risk parity".

Ajouter des contraintes au portefeuille tangent:

+ Poids $<=$ 20%
+ Secteur Technologie $<=$ 30%


https://cran.r-project.org/web/packages/riskParityPortfolio/vignettes/RiskParityPortfolio.html

